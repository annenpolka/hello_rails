<div class="container">
  <h1>ğŸ”Œ ãƒ•ãƒ¬ãƒ³ãƒ‰é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  - è¤‡æ•°WebSocketæ¥ç¶š</h1>
  
  <div class="user-info">
    <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>
    <div id="current-user">
      <% if current_user %>
        ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <%= current_user.email_address %> (ID: <%= current_user.id %>)
      <% else %>
        æœªãƒ­ã‚°ã‚¤ãƒ³
      <% end %>
    </div>
    
    <div class="user-switcher">
      <h4>ğŸ”„ è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆç”¨åˆ‡ã‚Šæ›¿ãˆ</h4>
      <p class="switcher-note">â€» ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã‚’ç„¡è¦–ã—ã¦ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§WebSocketæ¥ç¶šã§ãã¾ã™</p>
      <div class="switcher-controls">
        <select id="test-user-select">
          <option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ...</option>
          <% User.all.each do |user| %>
            <option value="<%= user.id %>" data-email="<%= user.email_address %>">
              <%= user.email_address %> (ID: <%= user.id %>)
            </option>
          <% end %>
        </select>
        <button id="connect-as-user" disabled>ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§æ¥ç¶š</button>
        <button id="disconnect-websockets">å…¨ã¦åˆ‡æ–­</button>
      </div>
      <div id="active-connection-info" class="connection-info"></div>
    </div>
  </div>
  
  <div class="connection-status">
    <h3>æ¥ç¶šçŠ¶æ³</h3>
    <div class="connections">
      <div class="connection-item">
        <strong>ä¸€èˆ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong>
        <span id="kafka-connection-status" class="status disconnected">ğŸ”´ æœªæ¥ç¶š</span>
      </div>
      <div class="connection-item">
        <strong>å€‹äººé€šçŸ¥:</strong>
        <span id="user-connection-status" class="status disconnected">ğŸ”´ æœªæ¥ç¶š</span>
      </div>
    </div>
  </div>

  <div class="friend-actions">
    <h3>ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½</h3>
    <div class="friend-section">
      <div class="input-group">
        <input type="email" id="friend-email" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
        <button id="send-friend-request" disabled>ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹é€ä¿¡</button>
      </div>
      
      <div class="input-group">
        <input type="number" id="friend-id" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (1-5)" />
        <select id="activity-type">
          <option value="game_invite">ã‚²ãƒ¼ãƒ æ‹›å¾…</option>
          <option value="chat_message">ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</option>
          <option value="status_update">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</option>
          <option value="achievement">ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆ</option>
        </select>
        <input type="text" id="activity-message" placeholder="é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" />
        <button id="send-activity" disabled>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥</button>
      </div>
      <div class="test-note">
        <small>â€» ãƒ†ã‚¹ãƒˆç’°å¢ƒ: ãƒ•ãƒ¬ãƒ³ãƒ‰é–¢ä¿‚ãªã—ã§ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã‚’é€ä¿¡å¯èƒ½</small>
      </div>
    </div>
  </div>

  <div class="message-sender">
    <h3>ä¸€èˆ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</h3>
    <div class="input-group">
      <select id="message-type">
        <option value="user_message">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</option>
        <option value="system_notification">ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥</option>
        <option value="order_update">æ³¨æ–‡æ›´æ–°</option>
        <option value="user_signup">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</option>
      </select>
      <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
      <button id="send-button" disabled>é€ä¿¡</button>
    </div>
  </div>

  <div class="message-display">
    <h3>å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
    <div class="controls">
      <button id="clear-messages">ã‚¯ãƒªã‚¢</button>
      <label>
        <input type="checkbox" id="auto-scroll" checked> è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      </label>
    </div>
    <div id="messages-container"></div>
  </div>
</div>

<style>
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  font-family: Arial, sans-serif;
}

.user-info, .connection-status, .friend-actions, .message-sender, .message-display {
  margin-bottom: 30px;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #f9f9f9;
}

.connections {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.connection-item {
  display: flex;
  align-items: center;
  gap: 10px;
}

.friend-section {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.status {
  padding: 10px;
  border-radius: 4px;
  font-weight: bold;
}

.status.connected {
  background: #d4edda;
  color: #155724;
}

.status.disconnected {
  background: #f8d7da;
  color: #721c24;
}

.input-group {
  display: flex;
  gap: 10px;
  align-items: center;
}

.input-group select, .input-group input {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.input-group input {
  flex: 1;
}

.input-group button {
  padding: 8px 16px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.input-group button:disabled {
  background: #6c757d;
  cursor: not-allowed;
}

.controls {
  margin-bottom: 10px;
  display: flex;
  gap: 15px;
  align-items: center;
}

.controls button {
  padding: 6px 12px;
  background: #6c757d;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

#messages-container {
  height: 400px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  background: white;
  border-radius: 4px;
}

.message {
  margin-bottom: 15px;
  padding: 10px;
  border-left: 4px solid #007bff;
  background: #f8f9fa;
  border-radius: 4px;
}

.message.sent {
  border-left-color: #28a745;
  background: #d4edda;
}

.message.received {
  border-left-color: #17a2b8;
  background: #d1ecf1;
}

.message.error {
  border-left-color: #dc3545;
  background: #f8d7da;
}

.message.sending {
  border-left-color: #ffc107;
  background: #fff3cd;
  opacity: 0.8;
}

.message-header {
  font-weight: bold;
  margin-bottom: 5px;
  font-size: 0.9em;
  color: #666;
}

.message-content {
  margin-bottom: 5px;
}

.message-meta {
  font-size: 0.8em;
  color: #999;
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ */
.user-switcher {
  margin-top: 20px;
  padding: 15px;
  background: #e3f2fd;
  border: 1px solid #90caf9;
  border-radius: 6px;
}

.user-switcher h4 {
  margin: 0 0 10px 0;
  color: #1565c0;
}

.switcher-note {
  font-size: 0.9em;
  color: #666;
  margin: 0 0 15px 0;
  font-style: italic;
}

.switcher-controls {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.switcher-controls select {
  flex: 1;
  min-width: 200px;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.switcher-controls button {
  padding: 8px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

#connect-as-user {
  background: #4caf50;
  color: white;
}

#connect-as-user:disabled {
  background: #cccccc;
  cursor: not-allowed;
}

#disconnect-websockets {
  background: #f44336;
  color: white;
}

.connection-info {
  margin-top: 15px;
  padding: 10px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.9em;
  min-height: 20px;
}

.connection-info.active {
  background: #d4edda;
  border-color: #c3e6cb;
  color: #155724;
}

.test-note {
  margin-top: 10px;
  padding: 8px;
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 4px;
  font-style: italic;
  color: #856404;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸš€ ãƒ•ãƒ¬ãƒ³ãƒ‰é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  loaded');
  
  // DOMè¦ç´ ã‚’å–å¾—
  const kafkaStatusElement = document.getElementById('kafka-connection-status');
  const userStatusElement = document.getElementById('user-connection-status');
  const messageInput = document.getElementById('message-input');
  const messageType = document.getElementById('message-type');
  const sendButton = document.getElementById('send-button');
  const messagesContainer = document.getElementById('messages-container');
  const clearButton = document.getElementById('clear-messages');
  const autoScrollCheckbox = document.getElementById('auto-scroll');
  
  // ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½è¦ç´ 
  const friendEmail = document.getElementById('friend-email');
  const sendFriendRequestButton = document.getElementById('send-friend-request');
  const friendId = document.getElementById('friend-id');
  const activityType = document.getElementById('activity-type');
  const activityMessage = document.getElementById('activity-message');
  const sendActivityButton = document.getElementById('send-activity');
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆè¦ç´ 
  const testUserSelect = document.getElementById('test-user-select');
  const connectAsUserButton = document.getElementById('connect-as-user');
  const disconnectWebSocketsButton = document.getElementById('disconnect-websockets');
  const activeConnectionInfo = document.getElementById('active-connection-info');
  
  // æ¥ç¶šç®¡ç†
  let cable = null;
  let kafkaSubscription = null;
  let userSubscription = null;
  let kafkaConnected = false;
  let userConnected = false;
  let messageCount = 0;
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
  const sessionUserId = <%= current_user&.id || 'null' %>;
  let activeUserId = sessionUserId; // ãƒ†ã‚¹ãƒˆç”¨ã«åˆ‡ã‚Šæ›¿ãˆå¯èƒ½
  
  // ActionCableã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
  function checkActionCable() {
    if (typeof window.ActionCable === 'undefined') {
      console.error('âŒ ActionCable is not available');
      statusElement.textContent = 'âŒ ActionCableæœªèª­ã¿è¾¼ã¿';
      statusElement.className = 'status disconnected';
      return false;
    }
    console.log('âœ… ActionCable is available');
    return true;
  }
  
  // æ¥ç¶šçŠ¶æ³ã‚’æ›´æ–°
  function updateKafkaConnectionStatus(isConnected) {
    kafkaConnected = isConnected;
    updateButtonStates();
    
    if (isConnected) {
      kafkaStatusElement.textContent = 'ğŸŸ¢ æ¥ç¶šä¸­';
      kafkaStatusElement.className = 'status connected';
    } else {
      kafkaStatusElement.textContent = 'ğŸ”´ æœªæ¥ç¶š';
      kafkaStatusElement.className = 'status disconnected';
    }
  }
  
  function updateUserConnectionStatus(isConnected) {
    userConnected = isConnected;
    updateButtonStates();
    
    if (isConnected) {
      userStatusElement.textContent = 'ğŸŸ¢ æ¥ç¶šä¸­';
      userStatusElement.className = 'status connected';
    } else {
      userStatusElement.textContent = 'ğŸ”´ æœªæ¥ç¶š';
      userStatusElement.className = 'status disconnected';
    }
  }
  
  function updateButtonStates() {
    sendButton.disabled = !kafkaConnected;
    sendFriendRequestButton.disabled = !userConnected || !activeUserId;
    sendActivityButton.disabled = !userConnected || !activeUserId;
    connectAsUserButton.disabled = !testUserSelect.value;
    
    // æ¥ç¶šæƒ…å ±ã‚’æ›´æ–°
    updateConnectionInfo();
  }
  
  function updateConnectionInfo() {
    if (activeUserId) {
      const selectedOption = testUserSelect.querySelector(`option[value="${activeUserId}"]`);
      const email = selectedOption ? selectedOption.dataset.email : 'Unknown';
      activeConnectionInfo.textContent = `ğŸ”— æ¥ç¶šä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${email} (ID: ${activeUserId})`;
      activeConnectionInfo.className = 'connection-info active';
    } else {
      activeConnectionInfo.textContent = 'æœªæ¥ç¶š';
      activeConnectionInfo.className = 'connection-info';
    }
  }
  
  // WebSocketæ¥ç¶š
  function connect() {
    if (!checkActionCable()) return;
    
    if (cable) {
      cable.disconnect();
    }
    
    console.log('ğŸ”Œ Connecting to WebSocket...');
    cable = window.ActionCable.createConsumer();
    
    // ä¸€èˆ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã®KafkaChannelæ¥ç¶š
    kafkaSubscription = cable.subscriptions.create('KafkaChannel', {
      connected: function() {
        console.log('âœ… WebSocket connected to KafkaChannel');
        updateKafkaConnectionStatus(true);
      },
      
      disconnected: function() {
        console.log('âŒ WebSocket disconnected from KafkaChannel');
        updateKafkaConnectionStatus(false);
      },
      
      received: function(data) {
        console.log('ğŸ“¨ KafkaChannel received:', data);
        handleKafkaMessage(data);
      }
    });
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å€‹äººé€šçŸ¥ç”¨ã®UserChannelæ¥ç¶š
    if (activeUserId) {
      userSubscription = cable.subscriptions.create({
        channel: 'UserChannel',
        user_id: activeUserId
      }, {
        connected: function() {
          console.log('âœ… WebSocket connected to UserChannel');
          updateUserConnectionStatus(true);
        },
        
        disconnected: function() {
          console.log('âŒ WebSocket disconnected from UserChannel');
          updateUserConnectionStatus(false);
        },
        
        rejected: function() {
          console.log('âŒ UserChannel subscription rejected (authentication failed)');
          updateUserConnectionStatus(false);
          displayMessage({
            type: 'error',
            header: 'âŒ å€‹äººé€šçŸ¥æ¥ç¶šã‚¨ãƒ©ãƒ¼',
            content: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚',
            timestamp: new Date().toLocaleString()
          });
        },
        
        received: function(data) {
          console.log('ğŸ“¨ UserChannel received:', data);
          handleUserNotification(data);
        }
      });
    } else {
      console.log('âš ï¸ No active user ID, skipping UserChannel connection');
      updateUserConnectionStatus(false);
    }
  }
  
  // ä¸€èˆ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  function sendMessage() {
    const content = messageInput.value.trim();
    const type = messageType.value;
    
    if (!content) {
      alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!kafkaConnected) {
      alert('KafkaChannelãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    console.log('ğŸ“¤ Sending message:', { content, type });
    kafkaSubscription.perform('send_message', {
      content: content,
      type: type
    });
    
    messageInput.value = '';
  }
  
  // ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹é€ä¿¡
  function sendFriendRequest() {
    const email = friendEmail.value.trim();
    
    if (!email) {
      alert('ãƒ•ãƒ¬ãƒ³ãƒ‰ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!userConnected) {
      alert('UserChannelãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    console.log('ğŸ“¤ Sending friend request to:', email);
    userSubscription.perform('send_friend_request', {
      friend_email: email
    });
    
    friendEmail.value = '';
  }
  
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£é€šçŸ¥é€ä¿¡
  function sendActivityNotification() {
    const fId = friendId.value.trim();
    const aType = activityType.value;
    const message = activityMessage.value.trim();
    
    if (!fId || !message) {
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!userConnected) {
      alert('UserChannelãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    console.log('ğŸ“¤ Sending activity notification:', { userId: fId, aType, message });
    userSubscription.perform('send_activity_notification', {
      friend_id: parseInt(fId),
      activity_type: aType,
      message: message
    });
    
    friendId.value = '';
    activityMessage.value = '';
  }
  
  // Kafkaãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
  function handleKafkaMessage(data) {
    // ãƒ‡ãƒ¼ã‚¿ãŒJSONæ–‡å­—åˆ—ã®å ´åˆã¯ãƒ‘ãƒ¼ã‚¹
    if (typeof data === 'string') {
      try {
        data = JSON.parse(data);
      } catch (e) {
        console.error('âŒ Failed to parse JSON:', e);
        return;
      }
    }
    
    switch (data.action) {
      case 'message_sent':
        let statusText = '';
        let messageType = 'sent';
        
        switch (data.status) {
          case 'sending':
            statusText = 'é€ä¿¡ä¸­';
            messageType = 'sending';
            break;
          case 'success':
            statusText = 'é€ä¿¡æˆåŠŸ';
            messageType = 'sent';
            break;
          case 'failed':
            statusText = 'é€ä¿¡å¤±æ•—';
            messageType = 'error';
            break;
          default:
            statusText = data.status;
        }
        
        displayMessage({
          type: messageType,
          header: `ğŸ“¤ ä¸€èˆ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸${statusText}`,
          content: data.status === 'success' 
            ? JSON.stringify(data.message, null, 2) + (data.kafka_info ? `\nKafka Info: ${JSON.stringify(data.kafka_info, null, 2)}` : '')
            : data.status === 'sending'
            ? `${data.note || 'é€ä¿¡ä¸­...'}\n${JSON.stringify(data.message, null, 2)}`
            : `ã‚¨ãƒ©ãƒ¼: ${data.error}`,
          timestamp: new Date().toLocaleString()
        });
        break;
        
      case 'message_received':
        displayMessage({
          type: 'received',
          header: 'ğŸ“¨ Kafkaãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡',
          content: JSON.stringify(data.payload, null, 2),
          meta: `Topic: ${data.kafka_metadata.topic}, Partition: ${data.kafka_metadata.partition}, Offset: ${data.kafka_metadata.offset}`,
          timestamp: new Date(data.kafka_metadata.timestamp).toLocaleString()
        });
        break;
        
      default:
        console.log('Unknown Kafka action:', data.action);
    }
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥å‡¦ç†
  function handleUserNotification(data) {
    switch (data.action) {
      case 'friend_request_sent':
      case 'friend_request_accepted':
      case 'friend_request_rejected':
      case 'activity_notification_sent':
        displayMessage({
          type: data.status === 'success' ? 'sent' : 'error',
          header: `ğŸ“± ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½: ${getActionLabel(data.action)}`,
          content: data.message,
          timestamp: new Date().toLocaleString()
        });
        break;
        
      case 'friend_notification':
        const payload = data.payload;
        let header = '';
        let msgType = 'received';
        
        switch (payload.type) {
          case 'friend_request':
            header = 'ğŸ“¬ æ–°ã—ã„ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹';
            break;
          case 'friend_accepted':
            header = 'âœ… ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹æ‰¿èª';
            break;
          case 'friend_activity':
            header = `ğŸ® ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£: ${payload.activity_type}`;
            break;
          default:
            header = 'ğŸ“¨ ãƒ•ãƒ¬ãƒ³ãƒ‰é€šçŸ¥';
        }
        
        displayMessage({
          type: msgType,
          header: header,
          content: payload.message,
          meta: payload.from_user ? `é€ä¿¡è€…: ${payload.from_user.email}` : '',
          timestamp: new Date(payload.timestamp).toLocaleString()
        });
        break;
        
      case 'error':
        displayMessage({
          type: 'error',
          header: 'âŒ ã‚¨ãƒ©ãƒ¼',
          content: data.message,
          timestamp: new Date().toLocaleString()
        });
        break;
        
      default:
        console.log('Unknown user notification action:', data.action);
    }
  }
  
  function getActionLabel(action) {
    const labels = {
      'friend_request_sent': 'ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹é€ä¿¡',
      'friend_request_accepted': 'ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹æ‰¿èª',
      'friend_request_rejected': 'ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹æ‹’å¦',
      'activity_notification_sent': 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£é€šçŸ¥é€ä¿¡'
    };
    return labels[action] || action;
  }
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  function displayMessage({ type, header, content, meta, timestamp }) {
    messageCount++;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.innerHTML = `
      <div class="message-header">${header} (#${messageCount})</div>
      <div class="message-content"><pre>${content}</pre></div>
      ${meta ? `<div class="message-meta">${meta}</div>` : ''}
      <div class="message-meta">æ™‚åˆ»: ${timestamp}</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    
    if (autoScrollCheckbox.checked) {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
  function clearMessages() {
    messagesContainer.innerHTML = '';
    messageCount = 0;
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  sendButton.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
  });
  
  sendFriendRequestButton.addEventListener('click', sendFriendRequest);
  friendEmail.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendFriendRequest();
  });
  
  sendActivityButton.addEventListener('click', sendActivityNotification);
  activityMessage.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendActivityNotification();
  });
  
  clearButton.addEventListener('click', clearMessages);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  testUserSelect.addEventListener('change', function() {
    const selectedUserId = this.value;
    connectAsUserButton.disabled = !selectedUserId;
  });
  
  connectAsUserButton.addEventListener('click', function() {
    const selectedUserId = testUserSelect.value;
    if (selectedUserId) {
      connectAsUser(selectedUserId);
    }
  });
  
  disconnectWebSocketsButton.addEventListener('click', function() {
    disconnectWebSockets();
  });
  
  // WebSocketåˆ‡æ–­æ©Ÿèƒ½
  function disconnectWebSockets() {
    console.log('ğŸ”Œ WebSocketã‚’åˆ‡æ–­ä¸­...');
    
    if (cable) {
      cable.disconnect();
      cable = null;
      kafkaSubscription = null;
      userSubscription = null;
    }
    
    updateKafkaConnectionStatus(false);
    updateUserConnectionStatus(false);
    activeUserId = null;
    updateConnectionInfo();
    updateButtonStates();
    
    console.log('âœ… WebSocketåˆ‡æ–­å®Œäº†');
  }
  
  // æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã§WebSocketæ¥ç¶š
  function connectAsUser(userId) {
    console.log(`ğŸ”Œ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ${userId} ã§WebSocketæ¥ç¶šä¸­...`);
    
    // æ—¢å­˜ã®æ¥ç¶šã‚’åˆ‡æ–­
    disconnectWebSockets();
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æ›´æ–°
    activeUserId = parseInt(userId);
    
    // æ–°ã—ã„æ¥ç¶šã‚’é–‹å§‹
    setTimeout(function() {
      connect();
    }, 500); // 500mså¾…ã£ã¦ã‹ã‚‰å†æ¥ç¶š
  }
  
  // åˆæœŸåŒ–
  if (!sessionUserId) {
    console.log('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ãŒã€ãƒ†ã‚¹ãƒˆç”¨åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã§ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦æ¥ç¶šã§ãã¾ã™ã€‚');
  }
  
  // åˆæœŸæ¥ç¶šï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚‹å ´åˆã®ã¿ï¼‰
  if (sessionUserId) {
    setTimeout(function() {
      connect();
    }, 1000); // 1ç§’å¾…ã£ã¦ã‹ã‚‰æ¥ç¶š
  } else {
    console.log('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—ã€‚ãƒ†ã‚¹ãƒˆç”¨åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
  }
});
</script>