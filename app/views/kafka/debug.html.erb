<div class="debug-container">
  <h1>ğŸ” ãƒ•ãƒ¬ãƒ³ãƒ‰é€šçŸ¥ãƒ‡ãƒãƒƒã‚°ãƒšãƒ¼ã‚¸</h1>
  
  <div class="current-user-info">
    <h2>ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±</h2>
    <% if @current_user %>
      <p><strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­:</strong> <%= @current_user.email_address %> (ID: <%= @current_user.id %>)</p>
    <% else %>
      <p><strong>æœªãƒ­ã‚°ã‚¤ãƒ³</strong> - <a href="/session/new">ãƒ­ã‚°ã‚¤ãƒ³</a></p>
    <% end %>
    <p><em>â€» ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¾å­˜ã›ãšã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŒ‡å®šã§ãã¾ã™</em></p>
  </div>

  <div class="test-notification-section">
    <h2>ğŸ“¤ ãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡</h2>
    <% if flash[:notice] %>
      <div class="notice" style="color: green; margin: 10px 0;">âœ… <%= flash[:notice] %></div>
    <% end %>
    <% if flash[:alert] %>
      <div class="alert" style="color: red; margin: 10px 0;">âŒ <%= flash[:alert] %></div>
    <% end %>
    
    <%= form_with url: kafka_send_test_notification_path, method: :post, local: true do |form| %>
      <div class="form-group">
        <%= form.label :user_id, "é€ä¿¡å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼:" %>
        <%= form.select :user_id, options_from_collection_for_select(@users, :id, ->(u) { "#{u.email_address} (ID: #{u.id})" }), { prompt: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ" }, { class: "form-select" } %>
      </div>
      
      <div class="form-group">
        <%= form.label :notification_type, "é€šçŸ¥ã‚¿ã‚¤ãƒ—:" %>
        <%= form.select :notification_type, [
          ['ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ (user_notifications)', 'user_notification'],
          ['ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ (friend_activities)', 'friend_activity']
        ], { prompt: "é€šçŸ¥ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ" }, { class: "form-select" } %>
      </div>
      
      <div class="form-group">
        <%= form.label :message, "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:" %>
        <%= form.text_area :message, placeholder: "ãƒ†ã‚¹ãƒˆé€šçŸ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›", class: "form-input" %>
      </div>
      
      <%= form.submit "ãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡", class: "btn btn-primary" %>
    <% end %>
  </div>

  <div class="friend-request-section">
    <h2>ğŸ‘« ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãƒ†ã‚¹ãƒˆ</h2>
    <%= form_with url: kafka_send_friend_request_path, method: :post, local: true, class: "friend-form" do |form| %>
      <div class="form-group-inline">
        <%= form.label :from_user_id, "é€ä¿¡è€…:" %>
        <%= form.select :from_user_id, options_from_collection_for_select(@users, :id, ->(u) { u.email_address }), { prompt: "é€ä¿¡è€…ã‚’é¸æŠ" }, { class: "form-select-small" } %>
        
        <span class="arrow">â†’</span>
        
        <%= form.label :to_user_id, "å—ä¿¡è€…:" %>
        <%= form.select :to_user_id, options_from_collection_for_select(@users, :id, ->(u) { u.email_address }), { prompt: "å—ä¿¡è€…ã‚’é¸æŠ" }, { class: "form-select-small" } %>
        
        <%= form.submit "ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹é€ä¿¡", class: "btn btn-success btn-small" %>
      </div>
    <% end %>
    
    <h3>â³ å¾…æ©Ÿä¸­ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</h3>
    <% pending_friendships = @friendships.select { |f| f.status == 'pending' } %>
    <% if pending_friendships.any? %>
      <div class="pending-requests">
        <% pending_friendships.each do |friendship| %>
          <div class="pending-item">
            <span><%= friendship.user.email_address %> â†’ <%= friendship.friend.email_address %></span>
            <%= form_with url: kafka_accept_friend_request_path, method: :post, local: true, class: "inline-form" do |form| %>
              <%= form.hidden_field :friendship_id, value: friendship.id %>
              <%= form.submit "æ‰¿èª", class: "btn btn-primary btn-mini" %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="no-data">å¾…æ©Ÿä¸­ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
    <% end %>
  </div>

  <div class="users-section">
    <h2>ğŸ‘¥ ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
    <table class="users-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>ãƒ•ãƒ¬ãƒ³ãƒ‰æ•°</th>
          <th>å¾…æ©Ÿä¸­ç”³è«‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |user| %>
          <tr>
            <td><%= user.id %></td>
            <td><%= user.email_address %></td>
            <td><%= user.friends.count %></td>
            <td><%= user.incoming_friendships.pending.count %></td>
            <td>
              <a href="/kafka/websocket" target="_blank">WebSocketç¢ºèª</a>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="friendships-section">
    <h2>ğŸ‘« æœ€è¿‘ã®ãƒ•ãƒ¬ãƒ³ãƒ‰é–¢ä¿‚</h2>
    <div class="friendships-controls">
      <%= form_with url: kafka_delete_all_friendships_path, method: :delete, local: true, class: "delete-all-form" do |form| %>
        <%= form.submit "ğŸ—‘ï¸ å…¨ãƒ•ãƒ¬ãƒ³ãƒ‰é–¢ä¿‚å‰Šé™¤", class: "btn btn-danger btn-small", 
            confirm: "å…¨ã¦ã®ãƒ•ãƒ¬ãƒ³ãƒ‰é–¢ä¿‚ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚" %>
      <% end %>
      <span class="friendships-count">ç·æ•°: <%= @friendships.count %>ä»¶</span>
    </div>
    <table class="friendships-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>ç”³è«‹è€…</th>
          <th>ç›¸æ‰‹</th>
          <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th>ä½œæˆæ—¥æ™‚</th>
        </tr>
      </thead>
      <tbody>
        <% @friendships.each do |friendship| %>
          <tr>
            <td><%= friendship.id %></td>
            <td><%= friendship.user.email_address %></td>
            <td><%= friendship.friend.email_address %></td>
            <td>
              <span class="status-<%= friendship.status %>">
                <%= case friendship.status
                    when 'pending' then 'â³ ä¿ç•™ä¸­'
                    when 'accepted' then 'âœ… æ‰¿èªæ¸ˆã¿'
                    when 'rejected' then 'âŒ æ‹’å¦æ¸ˆã¿'
                    else friendship.status
                    end %>
              </span>
            </td>
            <td><%= friendship.created_at.strftime("%Y-%m-%d %H:%M") %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="instructions-section">
    <h2>ğŸ“‹ è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆæ‰‹é †</h2>
    <ol>
      <li><strong>Karafka Consumerèµ·å‹•:</strong> <code>bundle exec karafka server</code></li>
      <li><strong>è¤‡æ•°ã‚¿ãƒ–ã§WebSocketæ¥ç¶š:</strong>
        <ul>
          <li><strong>Aliceç”¨:</strong> <a href="/kafka/websocket" target="_blank">WebSocketãƒšãƒ¼ã‚¸</a> â†’ alice@example.com ã§ãƒ­ã‚°ã‚¤ãƒ³</li>
          <li><strong>Bobç”¨:</strong> <a href="/kafka/websocket" target="_blank">æ–°ã—ã„ã‚¿ãƒ–</a> â†’ bob@example.com ã§ãƒ­ã‚°ã‚¤ãƒ³</li>
          <li><strong>Charlieç”¨:</strong> <a href="/kafka/websocket" target="_blank">æ–°ã—ã„ã‚¿ãƒ–</a> â†’ charlie@example.com ã§ãƒ­ã‚°ã‚¤ãƒ³</li>
        </ul>
      </li>
      <li><strong>ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãƒ†ã‚¹ãƒˆ:</strong> ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ ã§ Alice â†’ Bob ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</li>
      <li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¢ºèª:</strong> Bobã®WebSocketã‚¿ãƒ–ã§é€šçŸ¥ã‚’ç¢ºèª</li>
      <li><strong>æ‰¿èªãƒ†ã‚¹ãƒˆ:</strong> å¾…æ©Ÿä¸­ç”³è«‹ã®ã€Œæ‰¿èªã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯</li>
      <li><strong>åŒæ–¹å‘ç¢ºèª:</strong> Aliceã®WebSocketã‚¿ãƒ–ã§æ‰¿èªé€šçŸ¥ã‚’ç¢ºèª</li>
    </ol>
    
    <h3>ğŸ” ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</h3>
    <ul>
      <li><strong>Consumerãƒ­ã‚°:</strong> 
        <pre>ğŸ“¨ USER NOTIFICATION RECEIVED
   ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: 4
   é€šçŸ¥ã‚¿ã‚¤ãƒ—: friend_request
   ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: alice@example.comã•ã‚“ã‹ã‚‰ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ãŒå±Šãã¾ã—ãŸ</pre></li>
      <li><strong>WebSocketãƒ­ã‚°:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ <code>ğŸ“¨ UserChannel received</code></li>
      <li><strong>ç”»é¢è¡¨ç¤º:</strong> å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®WebSocketãƒšãƒ¼ã‚¸ã«é€šçŸ¥è¡¨ç¤º</li>
    </ul>
    
    <h3>ğŸ¯ ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªä¾‹</h3>
    <div class="scenario-example">
      <p><strong>ã‚·ãƒŠãƒªã‚ª:</strong> Alice â†’ Bob ã¸ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã¨æ‰¿èª</p>
      <ol>
        <li>ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ ã§ã€ŒAlice â†’ Bobã€ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹é€ä¿¡</li>
        <li>Bobã®WebSocketã‚¿ãƒ–ã§ã€ŒğŸ“¬ æ–°ã—ã„ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã€é€šçŸ¥ç¢ºèª</li>
        <li>å¾…æ©Ÿä¸­ç”³è«‹ã§ã€Œæ‰¿èªã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯</li>
        <li>Aliceã®WebSocketã‚¿ãƒ–ã§ã€Œâœ… ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹æ‰¿èªã€é€šçŸ¥ç¢ºèª</li>
        <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã§ãƒ•ãƒ¬ãƒ³ãƒ‰æ•°ãŒå¢—åŠ ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª</li>
      </ol>
    </div>
  </div>
</div>

<style>
.debug-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  font-family: Arial, sans-serif;
}

.current-user-info, .test-notification-section, .friend-request-section, .users-section, .friendships-section, .instructions-section {
  margin-bottom: 30px;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #f9f9f9;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-select, .form-input {
  width: 100%;
  max-width: 400px;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.form-input {
  min-height: 60px;
  resize: vertical;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.btn-primary {
  background-color: #007bff;
  color: white;
}

.btn-primary:hover {
  background-color: #0056b3;
}

.users-table, .friendships-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

.users-table th, .users-table td,
.friendships-table th, .friendships-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

.users-table th, .friendships-table th {
  background-color: #f5f5f5;
  font-weight: bold;
}

.status-pending { color: #856404; background: #fff3cd; padding: 2px 6px; border-radius: 3px; }
.status-accepted { color: #155724; background: #d4edda; padding: 2px 6px; border-radius: 3px; }
.status-rejected { color: #721c24; background: #f8d7da; padding: 2px 6px; border-radius: 3px; }

.notice { padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; }
.alert { padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; }

.instructions-section h3 {
  margin-top: 20px;
  color: #333;
}

.instructions-section ul, .instructions-section ol {
  margin-left: 20px;
}

.instructions-section code {
  background: #f4f4f4;
  padding: 2px 4px;
  border-radius: 3px;
  font-family: monospace;
}

/* ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.form-group-inline {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.form-select-small {
  width: auto;
  min-width: 150px;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.arrow {
  font-size: 18px;
  font-weight: bold;
  color: #666;
}

.btn-small {
  padding: 6px 12px;
  font-size: 13px;
}

.btn-mini {
  padding: 4px 8px;
  font-size: 12px;
}

.btn-success {
  background-color: #28a745;
  color: white;
}

.btn-success:hover {
  background-color: #218838;
}

.pending-requests {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 10px;
}

.pending-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.inline-form {
  display: inline-block;
}

.no-data {
  color: #666;
  font-style: italic;
  margin: 10px 0;
}

.scenario-example {
  background: #e8f5e8;
  padding: 15px;
  border-radius: 6px;
  margin-top: 15px;
}

.scenario-example p {
  margin-bottom: 10px;
  font-weight: bold;
}

.scenario-example ol {
  margin-left: 0;
}

pre {
  background: #f8f9fa;
  padding: 10px;
  border-radius: 4px;
  overflow-x: auto;
  font-size: 12px;
}

/* ãƒ•ãƒ¬ãƒ³ãƒ‰é–¢ä¿‚å‰Šé™¤æ©Ÿèƒ½ */
.friendships-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding: 10px;
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 4px;
}

.delete-all-form {
  display: inline-block;
}

.btn-danger {
  background-color: #dc3545;
  color: white;
}

.btn-danger:hover {
  background-color: #c82333;
}

.friendships-count {
  font-weight: bold;
  color: #666;
}
</style>